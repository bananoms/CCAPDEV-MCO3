mixin styleBlock()
  style.
    .step { display: none; }
    .step.active { display: block; }
    .btn-back { 
      background-color: #D9D9D9; 
      color: #11414E; 
      font-weight: 500; 
      font-size: 20px; 
      margin-right: 10px; 
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-back:hover { 
      background-color: #11414E; 
      color: #D9D9D9; 
    }
    .date-input-container {
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    .date-input-container label {
      font-weight: 500;
      font-size: 18px;
      color: #11414E;
    }
    .date-input-container input[type="date"] {
      padding: 12px;
      border: 1px solid #ffffff;
      border-radius: 6px;
      font-size: 16px;
      background-color: #fff;
      color: #11414E;
      max-width: 200px;
    }
    .step2-container {
      transform: scale(0.8);
      transform-origin: top center;
      overflow-x: auto;
      overflow-y: hidden;
      width: 125%;
      margin-left: -12.5%;
      padding-bottom: 20px;
    }
    .step2-content {
      min-width: 1200px;
      margin: 0 auto;
    }
    .step2-container::-webkit-scrollbar {
      height: 8px;
    }
    .step2-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    .step2-container::-webkit-scrollbar-thumb {
      background: #11414E;
      border-radius: 4px;
    }
    .step2-container::-webkit-scrollbar-thumb:hover {
      background: #3f7e8f;
    }

mixin step1()
  .step.active#step1.content-box.text-center.p-4
    h1 Reserve Laboratory Table
    p.mb-4
        | Ready to book your lab seat? Just fill out the form with your needed building and room.
        br
        | You'll get a confirmation as soon as your reservation is secured.
    .mb-4.d-flex.justify-content-center.gap-3.flex-wrap
      label(for="building_select")
      select#building_select.form-select.w-auto(name="building_select" onchange="checkNextButton()")
        option(value="") ðŸ¢ Building
        option(value="A") A
        option(value="B") B
        option(value="C") C
      label(for="room_select")
      select#room_select.form-select.w-auto(name="room_select" onchange="checkNextButton()")
        option(value="") ðŸ« Room
        option(value="GK101") GK101
        option(value="GK102") GK102
        option(value="GK103") GK103
        option(value="GK104") GK104
        option(value="GK105") GK105
    button#next-btn.main-btn.mt-3(onclick="nextStep()" disabled) Show Availability

mixin step2(timeSlots)
  .step#step2
    h2 Step 2: Select Date and Time Slot
    .selection-info
      strong Selected Location: 
      span#selected-location
    .mb-3.d-flex.justify-content-center.gap-3.flex-wrap
      label(for="date_select") ðŸ“… Date:
      input#date_select.form-control.w-auto(type="date" name="date_select" onchange="checkSubmitButton()")
    table.time-table#time-table
      thead 
        tr
          th
          each timeSlot in timeSlots
            th= timeSlot
      tbody#table-body
    button.btn.btn-back(onclick="prevStep()") Back
    button#submit-btn.btn(onclick="submitForm()" disabled) Submit

mixin scriptBlock()
  script.
    let selectedCells = [];
    
    // Set default date to today
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];
      document.getElementById('date_select').value = formattedDate;
      document.getElementById('date_select').min = formattedDate; // Prevent selecting past dates
      createTableRows();
      checkNextButton();
    });
    
    function checkNextButton() {
      const buildingSelect = document.getElementById('building_select');
      const roomSelect = document.getElementById('room_select');
      const nextBtn = document.getElementById('next-btn');
      
      // Enable next button only if building/room is selected
      const hasLocation = buildingSelect.value || roomSelect.value;
      nextBtn.disabled = !hasLocation;
    }
    
    function checkSubmitButton() {
      const submitBtn = document.getElementById('submit-btn');
      const dateSelect = document.getElementById('date_select');
      
      // Enable submit button only if date is selected and at least one cell is selected
      const hasDate = dateSelect.value;
      const hasSelectedCells = Object.keys(selectedCells).length > 0;
      submitBtn.disabled = !(hasDate && hasSelectedCells);
    }
    
    function createTableRows() {
      const tableBody = document.getElementById('table-body');
      tableBody.innerHTML = ''; // Clear existing rows
      
      for (let i = 1; i <= 8; i++) {
        const row = document.createElement('tr');
        const rowLabel = document.createElement('td');
        rowLabel.textContent = `A${i}`;
        row.appendChild(rowLabel);
        
        for (let j = 1; j <= 29; j++) {
          const cell = document.createElement('td');
          cell.dataset.row = i;
          cell.dataset.col = j;
          cell.addEventListener('click', function() { selectCell(this); });
          cell.addEventListener("contextmenu", (event) => { 
            event.preventDefault(); 
            deselectCell(event.currentTarget); 
          });
          row.appendChild(cell);
        }
        tableBody.appendChild(row);
      }
    }
    
    function selectCell(clickedCell) {
      const row = parseInt(clickedCell.dataset.row);
      const col = parseInt(clickedCell.dataset.col);
      const rowCells = document.querySelectorAll(`td[data-row="${row}"]`);
      
      // Clear previous selection for this row
      rowCells.forEach(cell => {
        if (cell.dataset.col !== '0') { // Don't affect row labels
          cell.classList.remove('selected');
        }
      });
      
      // Select current cell and adjacent cells
      rowCells.forEach(cell => {
        const cellCol = parseInt(cell.dataset.col);
        if (cellCol === col || cellCol === col+1 || cellCol === col-1) {
          cell.classList.add('selected');
        }
      });
      
      selectedCells[row] = col;
      checkSubmitButton();
    }
    
    function deselectCell(clickedCell) {
      const row = parseInt(clickedCell.dataset.row);
      const col = parseInt(clickedCell.dataset.col);
      const rowCells = document.querySelectorAll(`td[data-row="${row}"]`);
      
      rowCells.forEach(cell => {
        const cellCol = parseInt(cell.dataset.col);
        if (cellCol === col || cellCol === col+1 || cellCol === col-1) {
          cell.classList.remove("selected");
        }
      });
      
      delete selectedCells[row];
      checkSubmitButton();
    }
    
    function nextStep() {
      const buildingSelect = document.getElementById('building_select');
      const roomSelect = document.getElementById('room_select');
      
      if (buildingSelect.value || roomSelect.value) {
        let selectedLocation = '';
        if (buildingSelect.value && roomSelect.value) {
          selectedLocation = `Building: ${buildingSelect.value}, Room: ${roomSelect.value}`;
        } else if (buildingSelect.value) {
          selectedLocation = `Building: ${buildingSelect.value}`;
        } else if (roomSelect.value) {
          selectedLocation = `Room: ${roomSelect.value}`;
        }
        
        document.getElementById('selected-location').textContent = selectedLocation;
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.add('active');
        
        // Reset selected cells when moving to step 2
        selectedCells = [];
        checkSubmitButton();
      }
    }
    
    function prevStep() {
      document.getElementById('step2').classList.remove('active');
      document.getElementById('step1').classList.add('active');
      
      // Clear selected cells when going back
      selectedCells = [];
      const selectedElements = document.querySelectorAll('.selected');
      selectedElements.forEach(element => {
        element.classList.remove('selected');
      });
    }
    
    function submitForm() {
      const buildingSelect = document.getElementById('building_select');
      const roomSelect = document.getElementById('room_select');
      const dateSelect = document.getElementById('date_select');
      
      // Validate before submission
      if (!dateSelect.value) {
        alert('Please select a date before submitting.');
        return;
      }
      
      if (Object.keys(selectedCells).length === 0) {
        alert('Please select at least one time slot before submitting.');
        return;
      }
      
      let bookingData = {
        building: buildingSelect.value || null,
        room: roomSelect.value || null,
        date: dateSelect.value,
        time_slots: selectedCells
      };
      
      alert('Form submitted! Check console for booking data.');
      console.log('Booking Data:', bookingData);
    }
